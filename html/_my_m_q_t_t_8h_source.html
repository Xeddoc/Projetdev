<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Objets Connectés:  Fichier source de MyMQTT.h</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_ynov_campus_aix_rvb.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Objets Connectés
   </div>
   <div id="projectbrief">Outils de développement d&#39;objets connectés</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Généré par Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Recherche');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Recherche');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MyMQTT.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_my_m_q_t_t_8h.html">Aller à la documentation de ce fichier.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#include &lt;PubSubClient.h&gt;</span>                         <span class="comment">// PubSubClient MQTT</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="preprocessor">#include &lt;ESP8266WiFi.h&gt;</span>                          <span class="comment">// ESP8266 WiFi</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">#include &lt;ArduinoJson.h&gt;</span>                          <span class="comment">// JSON</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="preprocessor">#define MQTT_CLIENTID  &quot;MyNodeMCU&quot;                // Identifiant MQTT</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="preprocessor">#define MQTT_TOKEN     &quot;EOHShyDxOYLZWBXULdHg&quot;     // TOKEN du dispositif </span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="preprocessor">#define MQTT_SERVER    &quot;demo.thingsboard.io&quot;      // Adresse IP ou URL du broker MQTT</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="preprocessor">#define MQTT_PORT      1883                       // Port MQTT</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="preprocessor">#define MQTT_FREQ      10                         // Fréquence en secondes d&#39;envoi des données pour le ticker</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;WiFiClient    MyWiFiClient;                       <span class="comment">// Instanciation d&#39;un client web</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;PubSubClient  MyMqttClient(MyWiFiClient);         <span class="comment">// Instanciation du client MQTT</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;Ticker        MyMqttTicker;                       <span class="comment">// Ticker pour l&#39;envoi régulier de données au broker</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="keywordtype">int</span>           iMqttActuatorPin = 2;               <span class="comment">// Broche à utiliser pour l&#39;actuateur</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;String        strActuatorKey = <span class="stringliteral">&quot;MyActuatorState&quot;</span>; <span class="comment">// Nom de l&#39;attribut pour l&#39;actuateur</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">  167</a></span>&#160;String <a class="code" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a>() {</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  String strActuatorStatus;  </div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  StaticJsonDocument&lt;200&gt; payload;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  payload[strActuatorKey] = digitalRead(iMqttActuatorPin);</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  serializeJson(payload, strActuatorStatus);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Get actuator Status : &quot;</span>);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  MYDEBUG_PRINTLN(strActuatorStatus);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="keywordflow">return</span> strActuatorStatus;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;}</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#a64e98c5ece482f3db17ec5754f0e1cd8">  183</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_my_m_q_t_t_8h.html#a64e98c5ece482f3db17ec5754f0e1cd8">reconnectMQTT</a>(){</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordflow">if</span> (WiFi.status() != WL_CONNECTED){setupWiFi();}                          <span class="comment">// Vérification de la connexion WiFi</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordflow">while</span> (!MyMqttClient.connected()) {                                       <span class="comment">// Vérification de la connexion au serveur MQTT</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Connexion au serveur MQTT ... &quot;</span>);</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">if</span> ( MyMqttClient.connect(MQTT_CLIENTID, MQTT_TOKEN, NULL) ) { <span class="comment">// -------------- Connexion OK au serveur MQTT</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      MYDEBUG_PRINTLN(<span class="stringliteral">&quot;[OK]&quot;</span>);</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;      <span class="comment">// ------------------------------------------------------------------- SOUSCRIPTION</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      MYDEBUG_PRINTLN(<span class="stringliteral">&quot;-MQTT : Subscription&quot;</span>);</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      MyMqttClient.subscribe(<span class="stringliteral">&quot;v1/devices/me/rpc/request/+&quot;</span>);                 <span class="comment">// A toute les requêtes RPC</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      <span class="comment">// ------------------------------------------------------------------- PUBLICATION DES ATTRIBUTS</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      MYDEBUG_PRINTLN(<span class="stringliteral">&quot;-MQTT : Publication des attributs&quot;</span>);</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      DynamicJsonDocument jsonPayload(512);                                  <span class="comment">// Préparation de la Payload avec</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      jsonPayload[<span class="stringliteral">&quot;firmwareVersion&quot;</span>] = FIRMWAREVERSION;                      <span class="comment">// Version du firmware</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      jsonPayload[<span class="stringliteral">&quot;thingType&quot;</span>] = THINGTYPE;                                  <span class="comment">// Type d&#39;objet</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      jsonPayload[<span class="stringliteral">&quot;serialNumber&quot;</span>] = ESP.getChipId();                         <span class="comment">// Le numéro de série</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      jsonPayload[strActuatorKey] = digitalRead(iMqttActuatorPin);           <span class="comment">// Etat de l&#39;actuateur</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;                                                                             <span class="comment">// PAYLOAD </span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      String strAttributesPayload;                                           <span class="comment">// Préparation de la payload Attributes JSON </span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      serializeJson(jsonPayload, strAttributesPayload);                      <span class="comment">// Sérialisation du JSON</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      MyMqttClient.publish(<span class="stringliteral">&quot;v1/devices/me/attributes&quot;</span>, <a class="code" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a>().c_str()); <span class="comment">// Publication de la payload</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    } <span class="keywordflow">else</span> { <span class="comment">// ------------------------------------------------------------ Impossible de se connecter au serveur MQTT</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;      MYDEBUG_PRINT( <span class="stringliteral">&quot;[ERREUR] [ rc = &quot;</span> );</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      MYDEBUG_PRINT( MyMqttClient.state() );</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      MYDEBUG_PRINTLN( <span class="stringliteral">&quot; : Nouvelle tentative dans 5 sec]&quot;</span> );</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      delay(5000);</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    }</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  }</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;}</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#a8065e2dc80aa1458494c7a579f6fb696">  216</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_my_m_q_t_t_8h.html#a8065e2dc80aa1458494c7a579f6fb696">getAndSendMqttData</a>(){</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;  <span class="keywordflow">if</span> (!MyMqttClient.connected() ) { <a class="code" href="_my_m_q_t_t_8h.html#a64e98c5ece482f3db17ec5754f0e1cd8">reconnectMQTT</a>(); }</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="keywordflow">if</span> (MyMqttClient.connected()){                                           <span class="comment">// Si connecté alors on envoi les données</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">// ------------------------------------------------------------------- RECUPERATION DES DONNEES</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">int</span> myRandomInt = 25+random(-5,5);                                     <span class="comment">// Simulation de donnée Int</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">float</span> myRandomFloat = 20+(float)random(-100,100)/10;                   <span class="comment">// Simulation de donnée Float</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordtype">int</span> myRandomBool = rand() % 2;                                         <span class="comment">// Simulation de donnée Bool</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// ------------------------------------------------------------------- PUBLICATION DES TELEMETRIES</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    DynamicJsonDocument jsonPayload(512);                                  <span class="comment">// Préparation de la Payload avec</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    jsonPayload[<span class="stringliteral">&quot;MyTelemetryInt&quot;</span>] = myRandomInt;                           <span class="comment">// Un entier</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    jsonPayload[<span class="stringliteral">&quot;MyTelemetryFloat&quot;</span>] = myRandomFloat;                       <span class="comment">// Un float</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    jsonPayload[<span class="stringliteral">&quot;MyTelemetryBool&quot;</span>] = myRandomBool;                         <span class="comment">// Un booléen</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    jsonPayload[<span class="stringliteral">&quot;MyTelemetryString&quot;</span>] = <span class="stringliteral">&quot;MyString&quot;</span>;                         <span class="comment">// Un String</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    String strTelemetryPayload;                                            <span class="comment">// Préparation de la payload Attributes JSON </span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    serializeJson(jsonPayload, strTelemetryPayload);                       <span class="comment">// Sérialisation du JSON</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    MyMqttClient.publish(<span class="stringliteral">&quot;v1/devices/me/telemetry&quot;</span>, strTelemetryPayload.c_str()); <span class="comment">// Publication de la payload</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Message envoyé [&quot;</span>);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    MYDEBUG_PRINT(strTelemetryPayload);</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    MYDEBUG_PRINTLN(<span class="stringliteral">&quot;]&quot;</span>);</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;}</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#a42b9503dbd3acde97200c77365113c0e">  248</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_my_m_q_t_t_8h.html#a42b9503dbd3acde97200c77365113c0e">onMqttMessage</a>(<span class="keywordtype">char</span>* topic, byte* payload, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length) {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  StaticJsonDocument&lt;200&gt; jsonDocument;                                 <span class="comment">// Préparation du document JSON</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  DeserializationError error = deserializeJson(jsonDocument, payload);  <span class="comment">// Désérialisation de la Payload en JSON</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordflow">if</span> (error) {</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Parsing JSON IMPOSSIBLE&quot;</span>);</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    MYDEBUG_PRINTLN(error.c_str());</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  }</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">#ifdef MYDEBUG</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  String strMessage;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  serializeJson(jsonDocument, strMessage);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Message reçu / &quot;</span>);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot;Topic : &quot;</span>);</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  MYDEBUG_PRINT(topic);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot; / Message : &quot;</span>);</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  MYDEBUG_PRINTLN(strMessage);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  String strMethod = jsonDocument[<span class="stringliteral">&quot;method&quot;</span>]; <span class="comment">// Récupération du nom de la méthode</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Méthode appelée : &quot;</span>);</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  MYDEBUG_PRINTLN(strMethod);</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  <span class="keywordflow">if</span>(strMethod == <span class="stringliteral">&quot;getActuatorState&quot;</span>){ <span class="comment">// -------------------------------------- getActuatorState</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      String responseTopic = String(topic);                                      <span class="comment">// Préparation de la réponse</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      responseTopic.replace(<span class="stringliteral">&quot;request&quot;</span>, <span class="stringliteral">&quot;response&quot;</span>);                              <span class="comment">// Remplacement de la request en response</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      MyMqttClient.publish(responseTopic.c_str(), <a class="code" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a>().c_str());  <span class="comment">// Envoi de la réponse à la requête</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strMethod == <span class="stringliteral">&quot;setActuatorState&quot;</span>){ <span class="comment">// -------------------------------setActuatorState</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      String strValue = jsonDocument[<span class="stringliteral">&quot;params&quot;</span>];                                  <span class="comment">// Récupération de la valeur demandée</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      String responseTopic = String(topic);                                      <span class="comment">// Préparation de la réponse</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      responseTopic.replace(<span class="stringliteral">&quot;request&quot;</span>, <span class="stringliteral">&quot;response&quot;</span>);                              <span class="comment">// Remplacement de la request en response</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;      MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : paramètre : &quot;</span>);</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      MYDEBUG_PRINTLN(strValue);                                                 </div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      <span class="keywordflow">if</span> (strValue.equals(<span class="stringliteral">&quot;true&quot;</span>)){ digitalWrite(iMqttActuatorPin, HIGH); }</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      <span class="keywordflow">else</span>{ digitalWrite( iMqttActuatorPin, LOW); }</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      MyMqttClient.publish(responseTopic.c_str(), <a class="code" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a>().c_str());  <span class="comment">// Envoi de la réponse à la requête</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      MyMqttClient.publish(<span class="stringliteral">&quot;v1/devices/me/attributes&quot;</span>, <a class="code" href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a>().c_str()); <span class="comment">// Mise à jour de l&#39;attributs de l&#39;actuateur</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Méthode inconnue&quot;</span>);</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  }</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;}</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#a3cff6686f09444558b7c9436e082e73c">  295</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_my_m_q_t_t_8h.html#a3cff6686f09444558b7c9436e082e73c">setupMQTT</a>(){</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot;-MQTT : Initialisation Serveur : &quot;</span>);</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  MYDEBUG_PRINT(MQTT_SERVER);</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  MYDEBUG_PRINT(<span class="stringliteral">&quot; / Port : &quot;</span>);</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  MYDEBUG_PRINTLN(MQTT_PORT);</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  MyMqttClient.setServer(MQTT_SERVER, MQTT_PORT);      <span class="comment">// Configuration de la connexion au serveur MQTT</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  MyMqttClient.setCallback(<a class="code" href="_my_m_q_t_t_8h.html#a42b9503dbd3acde97200c77365113c0e">onMqttMessage</a>);             <span class="comment">// La fonction de callback qui est executée à chaque réception de message</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  MyMqttTicker.attach(MQTT_FREQ, <a class="code" href="_my_m_q_t_t_8h.html#a8065e2dc80aa1458494c7a579f6fb696">getAndSendMqttData</a>);  <span class="comment">// Envoi régulier des données à l&#39;aide d&#39;un Ticker</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  pinMode(iMqttActuatorPin, OUTPUT);                       <span class="comment">// Configuration de l&#39;actuateur</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  digitalWrite(iMqttActuatorPin, LOW);                     <span class="comment">// Initialisation de l&#39;actuateur à LOW</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;}</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="_my_m_q_t_t_8h.html#a23323891a8a0a21e9f8b48914821d9f6">  312</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="_my_m_q_t_t_8h.html#a23323891a8a0a21e9f8b48914821d9f6">loopMQTT</a>(){</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <span class="comment">// Vérification de l&#39;état de la connexion au serveur MQTT</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  <span class="keywordflow">if</span> ( !MyMqttClient.connected() ) { <a class="code" href="_my_m_q_t_t_8h.html#a64e98c5ece482f3db17ec5754f0e1cd8">reconnectMQTT</a>(); }</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  MyMqttClient.loop();</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;}</div><div class="ttc" id="_my_m_q_t_t_8h_html_a64e98c5ece482f3db17ec5754f0e1cd8"><div class="ttname"><a href="_my_m_q_t_t_8h.html#a64e98c5ece482f3db17ec5754f0e1cd8">reconnectMQTT</a></div><div class="ttdeci">void reconnectMQTT()</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:183</div></div>
<div class="ttc" id="_my_m_q_t_t_8h_html_a42b9503dbd3acde97200c77365113c0e"><div class="ttname"><a href="_my_m_q_t_t_8h.html#a42b9503dbd3acde97200c77365113c0e">onMqttMessage</a></div><div class="ttdeci">void onMqttMessage(char *topic, byte *payload, unsigned int length)</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:248</div></div>
<div class="ttc" id="_my_m_q_t_t_8h_html_ab3d3f0d4f3079ca2b652635ce3b2760b"><div class="ttname"><a href="_my_m_q_t_t_8h.html#ab3d3f0d4f3079ca2b652635ce3b2760b">getActuatorStatus</a></div><div class="ttdeci">String getActuatorStatus()</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:167</div></div>
<div class="ttc" id="_my_m_q_t_t_8h_html_a23323891a8a0a21e9f8b48914821d9f6"><div class="ttname"><a href="_my_m_q_t_t_8h.html#a23323891a8a0a21e9f8b48914821d9f6">loopMQTT</a></div><div class="ttdeci">void loopMQTT()</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:312</div></div>
<div class="ttc" id="_my_m_q_t_t_8h_html_a8065e2dc80aa1458494c7a579f6fb696"><div class="ttname"><a href="_my_m_q_t_t_8h.html#a8065e2dc80aa1458494c7a579f6fb696">getAndSendMqttData</a></div><div class="ttdeci">void getAndSendMqttData()</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:216</div></div>
<div class="ttc" id="_my_m_q_t_t_8h_html_a3cff6686f09444558b7c9436e082e73c"><div class="ttname"><a href="_my_m_q_t_t_8h.html#a3cff6686f09444558b7c9436e082e73c">setupMQTT</a></div><div class="ttdeci">void setupMQTT()</div><div class="ttdef"><b>Definition:</b> MyMQTT.h:295</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Généré par &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
